%%%

\section{Overview of \pelelm}

\pelelm\ evolves chemically reacting low Mach number flows with block-structured adaptive mesh refinement (AMR).
The code is built upon the core library, \amrex\ (\url{https://github.com/AMReX-Codes/amrex}),
to manages the underlying data structures, and the numerical time stepping of
a hierarchy of AMR grid levels. \pelelm\ borrows heavily
from the source code and algorithmic infrastructure of the \iamr\ code (\url{https://github.com/AMReX-Codes/IAMR})
that integrates the variable-density incompressible Navier-Stokes equations.
The core algorithms in \pelelm\ (and \iamr) are described in a series of papers:

\begin{itemize}

\item {\it A conservative, thermodynamically consistent numerical approach for low Mach number 
combustion. I. Single-level integration},
A.~Nonaka, J.~B.~Bell, and M.~S.~Day, Combust. Theor. Model., vol. 22, no. 1, pp. 156-184, 2018
\url{https://ccse.lbl.gov/Publications/nonaka/LMC_Pressure.pdf} \cite{LMC-P}.

\item {\it A Deferred Correction Coupling Strategy for Low Mach Number Flow with Complex Chemistry},
A.~Nonaka, J.~B.~Bell, M.~S.~Day, C.~Gilet, A.~S.~Almgren, and M.~L.~Minion,
Combust. Theory and Modelling, 16(6), 1053-1088, 2012. 
\url{http://www.tandfonline.com/doi/abs/10.1080/13647830.2012.701019} \cite{LMC_SDC}

\item {\it Numerical Simulation of Laminar Reacting Flows with Complex Chemistry},
M.~S.~Day and J.~B.~Bell,
Combust. Theory Modelling 4(4) pp.535-556, 2000.
\url{http://www.tandfonline.com/doi/abs/10.1088/1364-7830/4/4/309} \cite{DayBell:2000}

\item {\it An Adaptive Projection Method for Unsteady, Low-Mach Number Combustion}, 
R.~B.~Pember, L.~H.~Howell, J.~B.~Bell, P.~Colella, W.~Y.~Crutchfield, W.~A.~Fiveland, and J.~P.~Jessee,
Comb. Sci. Tech., 140, pp. 123-168, 1998.
\url{http://www.tandfonline.com/doi/abs/10.1080/00102209808915770} \cite{pember-flame}

\item {\it A Conservative Adaptive Projection Method for the Variable Density Incompressible Navier-Stokes Equations},
A.~S.~Almgren, J.~B.~Bell, P.~Colella, L.~H.~Howell, and M.~L.~Welcome,
J.~Comp.~Phys., 142, pp. 1-46, 1998.
\url{http://www.sciencedirect.com/science/article/pii/S0021999198958909} \cite{IAMR}

\end{itemize}         


\section{The low Mach number flow equations}
\newcommand{\etal}{{\it et al.}}

\pelelm\ solves the reacting Navier-Stokes flow equations in the \emph{low Mach number} regime~\cite{DayBell:2000,rehm1978equations,Majda:1985}. In the low Mach number regime, the characteristic fluid velocity is small compared to the sound speed, and the effect of acoustic wave propagation is unimportant to the overall dynamics of the system. Accordingly, acoustic wave propagation can be mathematically removed from the equations of motion, allowing for a numerical time step based on an advective CFL condition, and this leads to an increase in the allowable time step of order $1/M$ over an explicit, fully compressible method ($M$ is the Mach number).  In this mathematical framework, the total pressure is decomposed into the sum of a spatially constant (ambient) thermodynamic pressure $P_0$ and a perturbational pressure, $\pi({\vec x})$ that drives the flow.  Under suitable conditions (\cite{Majda:1985}), $\pi/P_0 = \mathcal{O} (M^2)$. 

The set of conservation equations specialized to the low Mach number regime is a system of PDEs with advection, diffusion and reaction (ADR) processes that are constrained to evolve on the manifold of a spatially constant $P_0$:

\begin{eqnarray}
&&\frac{\partial (\rho \boldsymbol{u})}{\partial t} + 
\nabla \cdot \left(\rho  \boldsymbol{u} \boldsymbol{u} + \tau \right)
= -\nabla \pi + \rho \, \boldsymbol{F}  ,
\nonumber
\\
&&\frac{\partial (\rho Y_m)}{\partial t} +
\nabla \cdot \left( \rho Y_m \boldsymbol{u} + \boldsymbol{\mathcal{F}}_{m} \right)
= \rho \, \dot{\omega}_m,
\label{eq:gen}
\\
&&\frac{ \partial (\rho h)}{ \partial t} +
\nabla \cdot \left( \rho h \boldsymbol{u} + \boldsymbol{\mathcal{Q}} \right) = 0 ,
\nonumber
\end{eqnarray}
where $\rho$ is the density, $\boldsymbol{u}$ is the velocity, $h$ is the mass-weighted enthalpy, $T$ is temperature and $Y_m$ is the mass fraction of species $m$. $\dot{\omega}_m$ is the molar production rate for species $m$, the modeling of which will be described in Section~\ref{ChemKinetics}. $\tau$ is the stress tensor, $\boldsymbol{\mathcal{Q}}$ is the heat flux vector and $\boldsymbol{\mathcal{F}}_m$
%$\,=\,$$- \rho \boldsymbol{\mathcal{D}}_i \nabla X_{i}$ 
are the species diffusion vectors. These transport fluxes require the evaluation of transport coefficients (e.g., the viscosity $\mu$, the conductivity $\lambda$ and the diffusivity matrix $D$) which are computed using the library EGLIB~\cite{EGLIB}, as will be described in more depth in Section~\ref{DifFluxesEGLIB}. The momentum source, $\boldsymbol{F}$, is a long-wavelength forcing term.  For a subset of cases of interest, $\boldsymbol{F}$ has been used to establish and maintain quasi-stationary turbulence. Note also that our definition of enthalpy here incorporates the standard heat of formation; thus there is no net change to $h$ due to reactions.

These evolution equations are supplemented by an equation of state for the thermodynamic pressure.  For example, the ideal gas law,
\begin{eqnarray}
P_0(\rho,Y_m,T)=\frac{\rho \mathcal{R} T}{W}=\rho \mathcal{R} T \sum_m \frac{Y_m}{W_m}
\label{eq:eos}
\end{eqnarray}
can be used, although \pelelm\ will soon support other more general expressions, such as
Soave-Redlich-Kwong~\cite{Soave1972}.  In (\ref{eq:eos}), $W_m$ and $W$ are the species $m$, and mean
molecular weights, respectively.  To close the system
we also require a relationship between enthalpy, species and temperature.  We adopt the definition used in the CHEMKIN standard, 
\begin{eqnarray}
h=\sum_m Y_m h_m(T)
\end{eqnarray}
where $h_m$ is the species $m$ enthalpy.  As noted above, this form incorporates the heat of formation for each species into the data bases that provide expressions for $h_m(T)$.

Neither species diffusion nor reactions redistribute the total mass, hence we have $\sum_m \boldsymbol{\mathcal{F}}_m = 0$ and $\sum_m \dot{\omega}_m = 0$. Thus, summing the species equations and using the definition $\sum_m Y_m \equiv 1$ we obtain the continuity equation:
\begin{eqnarray}
\frac{\partial \rho}{\partial t} + \nabla \cdot \rho \boldsymbol{u} = 0
\label{eq:cont}
\end{eqnarray}

Equations~(\ref{eq:gen}), together with the equation of state, (\ref{eq:eos}) form a differential-algebraic equation (DAE) system that describes evolution subject to a constraint.  A standard approach to attacking such a system computationally is to differente the constraint until it can be recast as an initial value problem.  Following this procedure, we set the thermodynamic pressure constant in the frame of the fluid,
\begin{eqnarray}
\frac{DP_0}{Dt} = 0
\label{eq:deos}
\end{eqnarray}
and observe that if the initial conditions satisfy the constraint, an evolution satisfying (\ref{eq:deos}) 
will continue to satisfy the constraint over all time.  Expanding (\ref{eq:deos}) via the chain rule, and using
Eq.~\ref{eq:cont}:
\begin{eqnarray}
\nabla \cdot \boldsymbol{u} = \frac{1}{T}\frac{DT}{Dt} + W \sum_m \frac{1}{W_m} \frac{DY_m}{Dt} = S
\label{eq:veloconstr}
\end{eqnarray}
The constraint then take the form here as a condition on the divergence of the flow.  Note that the actual expressions to use in (\ref{eq:veloconstr}) will depend on the model for evaluating the transport fluxes in (\ref{eq:gen}).


%%%
\subsection{Transport fluxes}
\label{sub:DifFluxes}
Expressions for the transport fluxes appearing in Eqs.~(\ref{eq:gen}) can be approximated in the Enskog-Chapman expansion as~\cite{Ern:1994multicomponent}:
 \begin{eqnarray*}
&&\boldsymbol{\mathcal{F}}_{m} = \rho Y_m \boldsymbol{V_m}
\\ [2mm]
&&\tau_{i,j} = - \Big(\kappa - \frac{2}{3} \mu \Big) \delta_{i,j} \frac{\partial {u_k}}{\partial x_k} - \mu \Big(\frac{u_i}{\partial x_j} + \frac{u_j}{\partial x_i}\Big)
\\ [2mm]
&&\boldsymbol{\mathcal{Q}} =  \sum_m h_m \boldsymbol{\mathcal{F}}_{m}  - \lambda' \nabla T - P_0 \sum_m \theta_m \boldsymbol{d_m}
\end{eqnarray*}
where $\mu$ is the shear viscosity, $\kappa$ is the bulk viscosity, and $\lambda'$ is the partial thermal conductivity. In the \textit{full matrix diffusion model}, the vector of $m$ species diffusion velocities, $\boldsymbol{V_m}$, is given by:
 \begin{eqnarray*}
\boldsymbol{V_m} = - \sum_j  {D}_{m,j} \boldsymbol{d_j} - \theta_m \nabla ln(T)
\end{eqnarray*}
where ${D}_{m,j}$ are the binary diffusion coefficients, and $\theta_m$ are thermal diffusion coefficients associated with the Soret (mass concentration flux due to an energy gradient) and Dufour (the energy flux due to a mass concentration gradient) transport of species $m$. The transport driving force due to composition gradients, $\boldsymbol{d_m}$, is given by~\cite{Ern:1994multicomponent}:
 \begin{eqnarray*}
\boldsymbol{d_m} = \nabla X_m + (X_m -Y_m) \frac{\nabla P_0}{P_0}
\label{dmeqs}
\end{eqnarray*}

%%%
\section{The \pelelm\ equation set}
\label{SumUpEq}
The full diffusion model couples together the advance of all thermodynamics fields, including a dense matrix transport operator that is cumbersome to deal with computationally, while also being generally viewed as overkill for most practical combustion applications -- particularly those involving turbulent fluid dynamics.  For \pelelm, we make the following simplifying assumptions:
\begin{enumerate}
\item The bulk viscosity, $\kappa$ is negligible, compared to the shear viscosity,
\item The low Mach limit implies that there are no spacial gradients in the thermodynamic pressure,
\item The \textit{mixture-averaged}\ diffusion model is assumed, and
\item Dufour and Soret effects are negligible
\end{enumerate}

With these assumptions, the conservation equations take the following form:
\begin{eqnarray}
&&\frac{\partial (\rho \boldsymbol{u})}{\partial t} + 
\nabla \cdot \left(\rho  \boldsymbol{u} \boldsymbol{u} + \tau \right)
= -\nabla \pi + \rho \, \boldsymbol{F}  ,
\nonumber
\\
&&\frac{\partial (\rho Y_i)}{\partial t} +
\nabla \cdot \left( \rho Y_i \boldsymbol{u} + \boldsymbol{\mathcal{F}}_{i} \right)
= \rho \, \dot{\omega}_i,
\label{eq:pelelm}
\\
&&\frac{ \partial (\rho h)}{ \partial t} +
\nabla \cdot \left( \rho h \boldsymbol{u} + \boldsymbol{\mathcal{Q}} \right) = 0 ,
\nonumber
\end{eqnarray}
with
 \begin{eqnarray*}
&&\boldsymbol{\mathcal{F}}_{m} = \rho Y_m \boldsymbol{V_m} = - \rho D_{m,mix} \nabla X_m
\\ [2mm]
&&\tau_{i,j} = \frac{2}{3} \mu \delta_{i,j} \frac{\partial {u_k}}{\partial x_k} - \mu \Big(\frac{u_i}{\partial x_j} + \frac{u_j}{\partial x_i}\Big)
\\ [2mm]
&&\boldsymbol{\mathcal{Q}} =  \sum_m h_m \boldsymbol{\mathcal{F}}_{m}  - \lambda \nabla T
\end{eqnarray*}
Details about the computation of $\mu$, $\lambda$ and $D_{m,mix}$ are discussed in Section~\ref{subs:EGLIB}.
With these specializations, the velocity constraint (Eq~\ref{eq:veloconstr}) becomes:
\begin{eqnarray}
\nabla \cdot \boldsymbol{u} \;\;  \equiv \; S&=& \frac{1}{\rho c_{p} T}(\nabla \cdot \lambda \nabla T - \sum_m  \boldsymbol{\mathcal{F}}_{m} \cdot \nabla h_m) \nonumber
\\
&-& \frac{W}{\rho} \sum_m \frac{1}{W_m} \nabla \cdot \boldsymbol{\mathcal{F}}_{m} + \frac{1}{\rho} \sum_m \Big( \frac{W}{W_m} -\frac{h_m(T)}{c_{p} T} \Big)\dot{\omega}_m
\end{eqnarray}


% We will talk about this later in the document...
% The resolution of the system of equations presented is performed in a fractional step framework which prohibits, in general, to numerically conserve both species and enthalpy while satisfying the equation of state (eos) Eq.~\ref{eq:eos}. To deal with this issue, a pressure correction term is added to the constraint S in Eq.~\ref{eq:veloconstr} to damp the system back onto the ambient eos (?? CHECK THAT FORMULA):
% \begin{eqnarray}
% \hat{S} = S + f \frac{c_{p} - R}{\Delta t c_{p} \hat{p}} (\hat{p} - P_0)
% \end{eqnarray}
% where $\hat{p}$ is computed via the eos Eq.~\ref{eq:eos}, $R = \mathcal{R}/W$ and $f$ is a damping factor ($<1$).

% \subsection{Transport coefficients and mixture rules: the Ern and Giovangigli approximations}
% \label{subs:EGLIB}
The mixture-averaged transport coefficients discussed above can be evaluated from transport properties of the pure species. We follow the treatment used in the EGLib library, based on the theory/approximations developed by Ern and Givangigli~\cite{Ern:1994,Ern:2004}.

The following choices are currently implemented in \pelelm\ 
\begin{itemize}
\item The viscosity, $\mu$, is estimated based \textcolor{red}{FIXME}
\item The conductivity, $\lambda$, is based on an empirical mixture formula:
\begin{eqnarray*}
\lambda = \Big( \sum_m X_m (\lambda_m)^{\alpha} \Big)^{1/\alpha}, \;\; \alpha = 1/4
\end{eqnarray*}
\item The flux diffusion flux is approximated using the diagonal matrix $diag(\widetilde{ \Upsilon})$, where:
\begin{eqnarray}
\widetilde{ \Upsilon}_m = \frac{W_m}{W} D_{m,mix}, \;\;\;\mbox{where} \;\;\; D_{m,mix} = \frac{1-Y_m}{ \sum_{j \neq m} X_j / \mathcal{D}_{m,j}}
\label{eq:dmix}
\end{eqnarray}
This leads to a mixture-averaged approximation that is similar to that of Hirschfelder-Curtiss~\cite{Hirschfelder:1954}:
\begin{eqnarray*}
\rho Y_m \boldsymbol{V_m} = - \rho D_{m,mix} \frac{W_m}{W} \nabla X_m 
\end{eqnarray*}
\end{itemize}
Note that with these definitions, there is no guarantee that $\sum \boldsymbol{\mathcal{F}}_{m} = 0$, as
required for mass conservation. As discussed in Section~\ref{AlgoDetails}, an arbitrary ``correction flux,'' consistent with the mixture-averaged diffusion approximation, is added in \pelelm\ to enforce conservation.


\subsection{Pure species transport properties}
The mixture-averaged transport coefficients require expressions for the pure species binary transport coefficients.  These, in turn, depend upon the forces of interaction between colliding molecules, which are complex functions of the shape and properties of each binary pair of species involved, as well as of their environment, intermolecular distance, etc. In practice, these interactions are usually described by a Lennard-Jones 6-12 potential (for non polar molecules, Stockmayer potential otherwise) that relates the evolution of the potential energy of the pair of species to their intermolecular distance. Here, the single component viscosities and binary diffusion coefficients are given by~\cite{Hirschfelder:1954}:
\begin{eqnarray}
\eta_m = \frac{5}{16} \frac{\sqrt{\pi m_m k_B T}}{\pi \sigma^2_m \Omega^{(2,2)*}},
\hspace{4mm}
\mathcal{D}_{m,j} = \frac{3}{16}\frac{\sqrt{2 \pi k^3_B T^3/m_{m,j}}}{P_0 \pi \sigma^2_{m,j} \Omega^{(1,1)*}}
\label{binary}
\end{eqnarray}
where $k_B$ is the Boltzmann constant, $\sigma_m$ is the Lennard-Jones collision diameter and $m_m (= W_k/\mathcal{A})$ is the molecular mass of species $m$. $m_{m,j}$ is the reduced molecular mass and $\sigma_{m,j}$ is the reduced collision diameter of the $(m,j)$ pair, given by:
\begin{eqnarray}
m_{m,j} = \frac{m_m m_j }{ (m_m + m_j)},
\hspace{4mm}
\sigma_{m,j} = \frac{1}{2} \zeta^{-\frac{1}{6}}(\sigma_m + \sigma_j)
\label{redCollision}
\end{eqnarray}
where $\zeta=1$ if the partners are either both polar or both nonpolar, but in the case of a polar molecule ($p$) interacting with a nonpolar ($n$) molecule:
\begin{eqnarray*}
\zeta=1 + \frac{1}{4} \alpha^*_n (\mu^*_p)^2 \sqrt{\frac{\epsilon_p}{\epsilon_n}}
\end{eqnarray*}
with $ \alpha^*_n = \alpha_n / \sigma^3_n$ the reduced polarizability of the nonpolar molecule and  $\mu^*_p = \mu_p/\sqrt{\epsilon_p \sigma^3_p}$ the reduced dipole moment of the polar molecule, expressed in function of the Lennard-Jones potential $\epsilon_p$ of the $p$ molecule.

Both quantities appearing in~\ref{binary} rely upon the evaluation of \emph{collision integrals} $\Omega^{(\cdot,\cdot)*}$, which account for inter-molecular interactions, and are usually tabulated in function of reduced variables~\cite{Monchick:1961}:
\begin{itemize}
\item $\Omega^{(2,2)*}$ is tabulated in function of a reduced temperature ($T^*_m $) and a reduced dipole moment ($\delta^*_m$), given by:
\begin{eqnarray*}
T^*_m = \frac{k_BT}{\epsilon_m},
\hspace{4mm}
\delta^*_m = \frac{1}{2} \frac{\mu^2_m}{\epsilon_m \sigma^3_m}
\end{eqnarray*}
%where $\epsilon_m$ is the Lennard-Jones potential well depth and $\mu_m$ is the dipole moment of species $m$. 
\item $\Omega^{(1,1)*}$ is tabulated in function of a reduced temperature ($T^*_{m,j} $) and a reduced dipole moment ($\delta^*_{m,j}$), given by:
\begin{eqnarray*}
T^*_{m,j} = \frac{k_BT}{\epsilon_{m,j}},
\hspace{4mm}
\delta^*_{m,j} = \frac{1}{2} \frac{\mu^2_{m,j}}{\epsilon_{m,j} \sigma^3_{m,j}}
\end{eqnarray*}
where the reduced collision diameter of the pair ($\sigma_{m,j}$) is given by \ref{redCollision}; and the Lennard-Jones potential $\epsilon_{m,j}$ and dipole moment $\mu_{m,j}$ of the $(m,j)$ pair are given by:
\begin{eqnarray*}
\frac{\epsilon_{m,j}}{k_B} = \zeta^2 \sqrt{\frac{\epsilon_m}{k_B} \frac{\epsilon_j}{k_B}},
\hspace{4mm}
\mu^2_{m,j} = \xi \mu_m \mu_j 
\end{eqnarray*}
with $\xi = 1$ if $\zeta = 1$ and $\xi = 0$ otherwise.
\end{itemize}

The expression for the pure species thermal conductivities are more complex. They are assumed to be composed of translational, rotational and vibrational contributions~\cite{Warnatz:}:
\begin{eqnarray*}
\lambda_m = \frac{\eta_m}{W_m} (f_{tr}C_{v,tr} + f_{rot}C_{v,rot} + f_{vib}C_{v,vib})
\end{eqnarray*}
where
\begin{eqnarray*}
&&f_{tr} = \frac{5}{2}\Big(1-\frac{2}{\pi} \frac{C_{v,rot}}{C_{v,tr}} \frac{A}{B} \Big)
\\
&&f_{rot} = \frac{\rho \mathcal{D}_{m,m}}{\eta_m} \Big( 1 + \frac{2}{\pi} \frac{A}{B}  \Big)
 \\
&&f_{vib} = \frac{\rho \mathcal{D}_{m,m}}{\eta_m}
\end{eqnarray*}
and
\begin{eqnarray*}
A = \frac{5}{2} - \frac{\rho \mathcal{D}_{m,m}}{\eta_m},
\hspace{4mm}
B = Z_{rot} + \frac{2}{\pi} \Big( \frac{5}{3} \frac{C_{v,rot}}{\mathcal{R}} + \frac{\rho \mathcal{D}_{m,m}}{\eta_m} \Big)
\end{eqnarray*}
The molar heat capacities $C_{v,\cdot}$ depend on the molecule shape. In the case of a linear molecule:
\begin{eqnarray*}
\frac{C_{v,tr}}{\mathcal{R}} = \frac{3}{2},
\hspace{1.5em}
\frac{C_{v,rot}}{\mathcal{R}} = 1,
\hspace{1.5em} 
{C_{v,vib}} = C_v - \frac{5}{2} \mathcal{R}
\end{eqnarray*}
In the case of a nonlinear molecule, the expressions are
\begin{eqnarray*}
\frac{C_{v,tr}}{\mathcal{R}} = \frac{3}{2},
\hspace{1.5em} 
\frac{C_{v,rot}}{\mathcal{R}} =  \frac{3}{2},
\hspace{1.5em} 
{C_{v,vib}} = C_v - 3 \mathcal{R}
\end{eqnarray*}
For single-atom molecules the thermal conductivity reduces to:
\begin{eqnarray*}
\lambda_m = \frac{\eta_m}{W_m} (f_{tr}C_{v,tr} ) = \frac{15 \, \eta_m \mathcal{R}}{4 \, W_m}
\end{eqnarray*}
Finally, $Z_{rot}$ is the rotational relaxation number, a parameter given by~\cite{Parker:}:
\begin{eqnarray*}
Z_{rot}(T) = Z_{rot} (298) \frac{F(298)}{F(T)}
\end{eqnarray*}
with 
\begin{eqnarray*}
F(T) = 1 + \frac{\pi^{(3/2)}}{2} \sqrt{\frac{\epsilon/k_B}{T} } + \Big( \frac{\pi^2}{4} +2 \Big) \Big( \frac{\epsilon/k_B}{T} \Big) + \pi^{(3/2)}\Big( \frac{\epsilon/k_B}{T} \Big)^{(3/2)} 
\end{eqnarray*}

In \pelelm\ the pure species transport properties are evaluated with EGLib functions.  EGLib requires polynomial fits of the logarithm of each quantity versus the logarithm of the temperature.
\begin{eqnarray*}
ln(q_m) = \sum_{n=1}^4 a_{q,m,n} \, ln(T)^{(n-1)} 
\end{eqnarray*}
where $q_m$ represents $\eta_m$, $\lambda_m$ or $D_{m,j}$. These fits are generated as part of a preprocessing step managed by the tool \fuego\ based on the formula (and input data) discussed above.  In particular, for each chemical species represented, $j$, the preprocessor tool requires the following data: XXXXXX.  The role of \fuego\ to preprocess the model parameters for transport as well as chemical kinetics and thermodynamics, is discussed in some detail in Chapter~\ref{ch:fuego}.

%%%
\section{Chemical kinetics and the reaction source term}
\label{ChemKinetics}
Chemistry in combustion systems involves the $N_s$ species interacting through a set of $M_r$ elementary reaction steps, expressed as
\begin{eqnarray*}
\sum_{m=1}^{N_s} \nu_{m,j}'[X_m] \rightleftharpoons \sum_{m=1}^{N_s} \nu_{m,j}''[X_m],\quad for \quad j \in [1,M_r] 
\label{IntroKM1}
\end{eqnarray*}
where $[X_m]$ is the molar concentration of species $m$, and $\nu_{m,j}'$, $\nu_{m,j}''$ are the stoichiometric coefficients on the reactant and product sides of reaction $j$, associated with $m$. For such a system, the rate of reaction $j$ ($R_j$) can be expressed in terms of the the forward ($k_{f,j}$) and backward ($k_{r,j}$) rate coefficients,
\begin{eqnarray*} 
R_{j} = k_{f,j}\prod_{m=1}^{N_s}  [X_{m}]^{\nu_{m,j}'}-k_{r,j}\prod_{m=1}^{N_s} [X_{m}]^{\nu_{m,j}''}
\end{eqnarray*}
The net molar production rate, $ \dot{\omega}_m$, in Eq.~\ref{eq:pelelm} of species $m$ is obtained by
collating the rate of creation and destruction over reactions:
\begin{eqnarray*}
\dot{\omega}_m = \sum_{j=1}^{M_r} \nu_{m,j} R_j 
\label{IntroKM3}
\end{eqnarray*}
where $\nu_{m,j} =\nu_{m,j}'' - \nu_{m,j}'$. Expressions for the reaction rates coefficients $k_{(f,r),j}$ depend on the type of reaction considered. \pelelm \; relies on the CHEMKIN Arrhenius reaction format:
\begin{eqnarray*}
k_f = AT^{\beta} exp \left( \frac{-E_a}{RT}\right)
\end{eqnarray*}
where $A$ is the pre-exponential (frequency) factor, $\beta$ is the temperature exponent and $E_a$ is the activation energy. The CHEMKIN format additionally allows for a number of specializations of this format to represent pressure dependencies and third-body enhancements -- See the CHEMKIN Manual or Cantera website for additional information~\cite{Kee:1989,cantera}.

Most fundamental Arrhenius reactions are bidirectional, and typically only the forward rates are specified. In this case, the balance of forward and reverse rates are dictacted by equilibrium thermodynamics, via the equilibrium ``constant'', $K_{c,j}$.  In a low Mach system, $K_{c,j}$ is a function only of temperature and the thermodynamic properties of the reactants and products of reaction $j$,
\begin{eqnarray*}
&&k_{r,j} = \frac{k_{f,j}}{K_{c}(T)} \;\;\; \mbox{where} \;\;\; K_c=K_{p_i} \left( \frac{P_{0}}{RT} \right)^{\sum_{k=1}^{N_s} \nu_{ki}}
\\
&&\mbox{and} \;\;\; K_{p_i}=\exp \left( \frac{\Delta {S_j}^{0}}{R} - \frac{\Delta {H_j}^{0}}{RT} \right)
\end{eqnarray*}
$\Delta H_j$ and $\Delta S_j$ are the change in enthaply and entropy of the reaction $j$, and $P_0$ is the ambient thermodynamic pressure.

\section{Thermodynamic properties}
\label{ThermoProp}
TODO
%%%

\section{\fuego\ chemistry preprocessing}
\label{ThermoProp}

As discussed above, a typical model for \pelelm\ consists of a large number of parameters associated with the CHEMKIN parameterization of the Arrhenius reaction set, as well as fitting coefficients for the thermodynamic relationships, and the specification of the species, including those required to compute pure-species transport properties.  In the combustion community, these parameters are communicated in the form of text files that conform to the CHEMKIN standard.  The CHEMKIN software can then be used to ingest these parameters and provide a set of functions for evaluating all the properties and rates required.  Earlier versions of \pelelm\ linked to the CHEMKIN codes (and thereby assumed that all problems consisted of a mixture of ideal gases).  However, evaluations done this way were not very efficient because the software functions stepped through full, generic expressions.  A more direct evaluation is potentially much more efficient alternative to the CHEMKIN software.  Moreover, a customized solution could be developed to extend \pelelm\ to handle a larger class of gas models, such as SRK.

In a move away from CHEMKIN, \pelelm\ now relies on a preprocessing tool, \fuego, to generate highly efficient optimized C code implementations of the thermodynamic and kinetics evaluations.  This auto-generated code is linked into the \pelelm\ executable, customizing the executable for a specific model at compile time.  These implementation source code files can also be linked conveiently to post-processing analysis tools.

The \fuego\ processing tool, and the functions necessary to interface the generated functions to \pelelm\ are contained in the code package, \pelephysics.  In addition to CHEMKIN and SRK implementations, and the EGLib-based evaluations of transport coefficients, \pelephysics\ provides support for simpler \textit{gama-law}\ equations-of-state, and constant transport properties.  The distribution comes with a large set of models for the combustion of hydrogen, carbon-monoxide, methane, heptane, $n$-dodecane, dimethyl ether, and others, as well as instructions for users extend this set using \fuego\ based on their own CHEMKIN-complaint inputs.

%%%
\section{The \pelelm\ temporal integration}
The basic temporal discretization in \pelelm\ combines a simplified spectral deferred correction (SDC) coupling of chemistry and transport \cite{LMC_SDC} with a density-weighted approximate projection method for low Mach number flow \cite{DayBell:2000}.  The projection method implements a constrained evolution on the velocity field via the SDC iterations, which ensures that the update simultaneously satisfies the  equation of state and discrete conservation of mass and total enthalpy.
A time-explicit approach is used for advection; faster diffusion and chemistry processes are treated time-implicitly, and iteratively coupled together within the deferred corrections strategy. The integration algorithm, discussed in the following sections, is second-order accurate in space and time, and is implemented in the context of a subcycled approach to time-stepping a hierarchy of mesh levels, where each level consists of logically rectangular patches of rectangular cells.  All cells at a level have the same size, and are isotropic in all coordinates.  We discuss first the ``single-level'' advance, and then discuss modifications necessary to support the AMR subcycling strategy.

\subsection{Algorithm summary}
\label{AlgoDetails}
SDC methods for ODEs are introduced in Dutt et al.~\cite{Dutt:2000}.
The basic idea of SDC is to write the solution of an ODE
\begin{eqnarray}
\phi_t &=& F(t,\phi(t)), \qquad t\in[t^n,t^{n+1}];\\
\phi(t^n) &=& \phi^n,
\end{eqnarray}
as an integral,
\begin{equation}
\phi(t) = \phi^n + \int_{t^n}^{t} F(\phi)~d\tau,
\end{equation}
where we suppress explicit dependence of $F$ and $\phi$ on $t$ for notational simplicity.
Given an approximation $\phi^{(k)}(t)$ to $\phi(t)$, one can then define a residual,
\begin{equation}
E(t,\phi^{(k)}) = \phi^n + \int_{t^n}^t F(\phi^{(k)})~d\tau - \phi^{(k)}(t).\label{eq:residual}
\end{equation}
Defining the error as $\delta^{(k)}(t) = \phi(t) - \phi^{(k)}(t)$, one can then show that
\begin{equation}
\delta^{(k)}(t) = \int_{t^n}^t \left[F(\phi^{(k)}+ \delta^{(k)}) - F(\phi^{(k)})\right]d\tau + E(t,\phi^{(k)}).\label{eq:correction}
\end{equation}
In SDC algorithms, the integral in (\ref{eq:residual}) 
is evaluated with a higher-order quadrature rule.
By using a low-order discretization of the integral in (\ref{eq:correction}) one can construct
an iterative scheme that improves the overall order of accuracy of the approximation by one per
iteration, up to the order of accuracy of the underlying quadrature rule 
used to evaluate the integral in (\ref{eq:residual}).
Specifically, if we let $\phi^{(k)}$ represent the current approximation and define 
$\phi^{(k+1)} = \phi^{(k)} + \delta^{(k)}$ to be the iterative update, 
then combining (\ref{eq:residual}) and (\ref{eq:correction}) results in an update equation,
\begin{equation}
\phi^{(k+1)}(t) = \phi^n + \int_{t^n}^t \left[F(\phi^{(k+1)}) - F(\phi^{(k)})\right]d\tau +
 \int_{t^n}^t F(\phi^{(k)})~d\tau,\label{eq:update}
\end{equation}
where a low-order discretization (e.g., forward or backward Euler) is used for the first integral 
and a higher-order quadrature is used to evaluate the second integral.  For our reacting flow model,
the underlying projection methodology for the time-advancement of velocity is second-order,
so we require the use of second-order (or higher) numerical quadrature for the second integral.

\subsection{MISDC Correction Equations}
Bourlioux et al.~\cite{BLM:2003} and Layton and Minion \cite{Layton:2004}
introduce a variant of SDC, referred to as MISDC, in which $F$ is decomposed into distinct
processes, each treated separately with methods appropriate to its own time scale.  Here, we write
\begin{equation}
\phi_t = F \equiv A(\phi) + D(\phi) + R(\phi),\label{eq:multi}
\end{equation}
to refer to advection, diffusion, and reaction processes.
For this construction we assume that we are given an approximate solution $\phi^{(k)}$ that
we want to improve. 
Using the ideas in \cite{BLM:2003,Layton:2004}, we develop 
a series of correction equations to update $\phi^{(k)}$ that uses relatively
simple second-order discretizations of $A(\phi)$ and $D(\phi)$ but a high-accuracy 
treatment of $R(\phi)$.  In our approach, $A(\phi^{(k)})$ is piecewise-constant over 
each time step, and is evaluated using a second-order Godunov procedure 
(see \cite{almgren-iamr} for full details on the Godunov procedure).
The Godunov procedure computes a time-centered 
advection term at $t^{n+\myhalf}$, and incorporates an explicit diffusion source term and an 
iteratively lagged reaction source term, i.e.,
\begin{equation}
A(\phi^{(k)}) \equiv A^{n+\myhalf,(k)} = A\left(\phi^n,D(\phi^n),I_R^{(k-1)}\right),
\end{equation}
where $I_R^{(k-1)}$ is the effective contribution due to reactions from the previous iteration, i.e.,
\begin{equation}
I_R^{(k-1)} = \frac{1}{t^{n+1}-t^n}\int_{t^n}^{t^{n+1}} R(\phi^{(k-1)})~d\tau.\label{eq:IR}
\end{equation}
$I_R^{(k-1)}$ is computed from a high-accuracy
integration of the reaction kinetics equations,
augmented with piecewise constant-in-time representation of advection and diffusion.
Details of this procedure are given below.
We also represent $D(\phi^{(k)})$ as piecewise-constant 
over the time step, found by using a midpoint rule,
\begin{equation}
D(\phi^{(k)}) = \half\left[D(\phi^n) + D(\phi^{n+1,(k)})\right].\label{eq:D^k}
\end{equation}

In the spirit of MISDC, we solve correction equations for the individual processes in 
(\ref{eq:multi}) sequentially.  We begin by discretizing (\ref{eq:update}), but only
including the advection and diffusion terms in the correction integral,
\begin{equation}
\phi_{\rm AD}^{(k+1)}(t) = \phi^n + \int_{t^n}^t \left[A(\phi^{(k+1)}) - A(\phi^{(k)}) + D(\phi^{(k+1)}) - D(\phi^{(k)})\right]d\tau + \int_{t^n}^t F(\phi^{(k)})~d\tau.\label{eq:AD Correction}
\end{equation}
Thus, $\phi_{\rm AD}^{(k+1)}(t)$ represents an updated approximation of the solution after correcting the
advection and diffusion terms only.  For the first integral, we use an explicit update for the advection term and a 
backward Euler discretization for the diffusion term.
For the second integral, we represent $F$ in terms of $A$, $D$, and $R$ and
use the definition
of $A(\phi^{(k)})$, $D(\phi^{(k)})$, and $I_R^{(k-1)}$ to obtain
a discretization of (\ref{eq:AD Correction}) for 
$\phi_{\rm AD}^{n+1,(k+1)}$:
\begin{eqnarray}
\phi_{\rm AD}^{n+1,(k+1)} &=& \phi^n + \Delta t  \left[A^{n+\myhalf,(k+1)} - A^{n+\myhalf,(k)} + D(\phi_{\rm AD}^{n+1,(k+1)}) - D(\phi^{n+1,(k)})\right] \nonumber \\
&&\hspace{0.5cm}+ \Delta t\left[A^{n+\myhalf,(k)} + \half\left(D(\phi^n) + D(\phi^{n+1,(k)})\right) + I_R^{(k)}\right],
\end{eqnarray}
where $I_R^{(k)}$ is defined using (\ref{eq:IR}).
This equation simplifies to the following backward Euler type linear system, with the
right-hand-side consisting of known quantities:
\begin{equation}
(\mathcal{I} - \Delta t D)\phi_{\rm AD}^{n+1,(k+1)} = \phi^n + \Delta t \left[A^{n+\myhalf,(k+1)} + \half\left(D(\phi^n) - D(\phi^{n+1,(k)})\right) + I_R^{(k)}\right].
\end{equation}
After computing $\phi_{\rm AD}^{n+1,(k+1)}$, we complete the update by solving a correction equation for
the reaction term.  Standard MISDC approaches would formulate the reaction correction equation as
\begin{eqnarray}
{\phi}^{(k+1)}(t) = \phi^n &+& \int_{t^n}^t \left[ A^{n+\myhalf,(k+1)} - A^{n+\myhalf,(k)} + D(\phi_{\rm AD}^{n+1,(k+1)}) - D(\phi^{n+1,(k)}) \right]~d\tau \nonumber \\
&+& \int_{t^n}^t \left[R(\phi^{(k+1)}) - R(\phi^{(k)})\right]d\tau + \int_{t^n}^t F(\phi^{(k)})~d\tau, \label{eq:stdreact}
\end{eqnarray}
and use a backward Euler type discretization for the integral of the reaction terms.
Here, to address stiffness issues with detailed chemical kinetics, we will instead
formulate the correction equation for the 
reaction as an ODE, which will be approximated using the VODE package.
In particular, by differentiating (\ref{eq:stdreact}) we obtain
\begin{eqnarray}
{\phi}^{(k+1)}_t &=& \left[ A^{n+\myhalf,(k+1)} - A^{n+\myhalf,(k)} + D(\phi_{\rm AD}^{n+1,(k+1)}) - D(\phi^{n+1,(k)}) \right]\nonumber\\
&&\hspace{-0.5cm}+ \left[R(\phi^{(k+1)}) - R(\phi^{(k)})\right] + \left[A^{n+\myhalf,(k)} + \half\left(D(\phi^n) + D(\phi^{n+1,(k)})\right) + R(\phi^{(k)})\right]\nonumber\\
&=& R(\phi^{(k+1)}) + \underbrace{A^{n+\myhalf,(k+1)} + D(\phi_{\rm AD}^{n+1,(k+1)}) + \half\left[D(\phi^n) - D(\phi^{n+1,(k)})\right]}_{F_{\rm AD}^{(k+1)}}, \label{eq:MISDCint}
\end{eqnarray}
which we then integrate with VODE to advance $\phi^n$ over $\Delta t$ to obtain $\phi^{n+1,(k+1)}$.
We note that from the integration, we can easily evaluate
$I_R^{(k+1)}$ that is needed for the next iteration,
\begin{equation}
I_R^{(k+1)} = \frac{\phi^{n+1,(k+1)} - \phi^n}{\Delta t} - F_{\rm AD}^{(k+1)}.
\end{equation}


\subsection{The \textit{MAC}\ and \textit{nodal}\ projections}
In this section we describe the numerical discretization of the low Mach number model, with
particular emphasis on the time-advancement of the thermodynamic variables.  The
overall approach is a second-order projection method with an embedded MISDC
strategy for advancing the thermodynamic variables.  

We use a finite-volume, Cartesian grid approach with constant grid spacing, where
$U$, $\rho$, $\rho Y_m$, $\rho h$, and $T$ represent cell averages,
whereas $\pi$ is defined as point-values on nodes at half 
time levels. There are three major steps in the algorithm:\\

{\bf Step 1}: ({\it Compute advection velocities}) Use a second-order Godunov procedure to predict a time-centered
velocity, $\uadvstar$, on cell faces using the cell-centered data at $t^n$ and the lagged pressure 
gradient from $t^{n-\myhalf}$.  
(An iterative procedure is used to define an initial pressure profile
for the algorithm; see \cite{AlmBelColHowWel98,DayBell:2000} for details.)
The provisional field, $\uadvstar$, represents 
a normal velocity on cell faces analogous to a MAC-type staggered grid discretization of the 
Navier-Stokes equations (see \cite{harlowwelch}, for example).  However, $\uadvstar$ fails to 
satisfy the divergence constraint (\ref{eq:modified constraint}).  We apply a discrete projection by solving the 
elliptic equation
\begin{equation}
D^{{\rm FC}\rightarrow{\rm CC}}\frac{1}{\rho^n}G^{{\rm CC}\rightarrow{\rm FC}}\phi = D^{{\rm FC}\rightarrow{\rm CC}}\uadvstar - \left(\widehat S^n + \frac{\Delta t^n}{2}\frac{\widehat S^n - \widehat S^{n-1}}{\Delta t^{n-1}}\right),
\end{equation}
for $\phi$ at cell-centers, where $D^{{\rm FC}\rightarrow{\rm CC}}$ represents a cell-centered divergence of face-centered data,
and $G^{{\rm CC}\rightarrow{\rm FC}}$ represents a face-centered gradient of cell-centered data, and $\rho^n$ is computed on
cell faces using arithmetic averaging from neighboring cell centers.
The solution, $\phi$, is then used to define
\begin{equation}
\uadv = \uadvstar - \frac{1}{\rho^n}G^{{\rm CC}\rightarrow{\rm FC}}\phi,
\end{equation}
Thus, $\uadv$ is a second-order accurate, staggered grid vector field at $t^{n+\myhalf}$ that discretely 
satisfies the constraint (\ref{eq:modified constraint}), and is used for computing the time-explicit 
advective fluxes for $U$, $\rho h$, and $\rho Y_m$.\\

{\bf Step 2}: ({\it Advance thermodynamic variables}) Integrate $(\rho Y_m,\rho h)$ over the full time step.  The details of this are presented in the next subsection.\\

{\bf Step 3}: ({\it Advance the velocity}) Compute $S^{n+1}$ from the new-time 
thermodynamic variables and an estimate of $\dot\omega_m^{n+1}$.  Evaluate
$\dot\omega_m^{n+1}$  directly from the new-time thermodynamic variables.

Next, we compute an intermediate cell-centered velocity field, 
$U^{n+1,*}$ using the lagged pressure gradient, by solving
\begin{equation}
\rho^{n+\myhalf}\frac{U^{n+1,*}-U^n}{\Delta t} + \left(\uadv\cdot\nabla U\right)^{n+\myhalf} = \half\left(\nabla\cdot\tau^n + \nabla\cdot\tau^{n+1,*}\right) - \nabla\pi^{n-\myhalf},
\end{equation}
where $\tau^{n+1,*} = \mu^{n+1}[\nabla U^{n+1,*} +(\nabla U^{n+1,*})^T - 2\mathcal{I}\widehat S^{n+1}/3]$ and 
$\rho^{n+\myhalf} = (\rho^n + \rho^{n+1})/2$.  This is a semi-implicit discretization for $U$, requiring
a linear solve.  The time-centered velocity in the advective derivative,
$U^{n+\myhalf}$, is computed in the same way 
as $\uadvstar$, but also includes the viscous stress tensor evaluated at $t^n$ as a source term
in the Godunov integrator.  At 
this point, the intermediate velocity field $U^{n+1,*}$ does not satisfy the constraint
(\ref{eq:modified constraint}).  Hence, we apply an 
approximate projection to update the pressure and to project $U^{n+1,*}$ onto the constraint surface.  
In particular, we solve
\begin{equation}
L^{{\rm N}\rightarrow{\rm N}}\phi = D^{{\rm CC}\rightarrow{\rm N}}\left(U^{n+1,*} + \frac{\Delta t}{\rho^{n+\myhalf}}G^{{\rm N}\rightarrow{\rm CC}}\pi^{n-\myhalf}\right) - \widehat S^{n+1}
\end{equation}
for nodal values of $\phi$.  Here, $L^{{\rm N}\rightarrow{\rm N}}$ represents a nodal Laplacian of nodal data, computed
using the standard bilinear finite-element approximation to $\nabla\cdot(1/\rho^{n+\myhalf})\nabla$.
Also, $D^{{\rm CC}\rightarrow{\rm N}}$ is a discrete
second-order operator that approximates the divergence at nodes from cell-centered data 
and $G^{{\rm N}\rightarrow{\rm CC}}$ approximates a cell-centered gradient from nodal data.  We compute nodal 
values for $\widehat S^{n+1}$ by interpolating the cell-centered values.  Finally, we 
determine the new-time cell-centered velocity field using
\begin{equation}
U^{n+1} = U^{n+1,*} - \frac{\Delta t}{\rho^{n+\myhalf}}G^{{\rm N}\rightarrow{\rm CC}}(\phi-\pi^{n-\myhalf}),
\end{equation}
and the new time-centered pressure using $\pi^{n+\myhalf} = \phi$.  This completes the 
description of the time-advancement algorithm.

\subsection{Thermodynamic Advance}\label{sec:Thermodynamic Advance}
Here we describe the details of Step 2 above, in
which we advance $(\rho Y_m,\rho h)$ over the full time step.
There are two steps:
\begin{itemize}
\item {\bf Step 2A:} ({\it Predictor}) Advance 
               $(\rho Y_m,\rho h)^n \rightarrow (\rho Y_m,\rho h)^{n+1,(0)}$ by 
               discretizing the full ADR system over the time interval $\Delta t$ using 
               a method that is first-order in time due to the use of
               time-lagged thermodynamic coefficients in the implicit
               treatment of diffusive terms. In this section, we simplify notation
               by suppressing the time step index,
               e.g., $(\rho Y_m,\rho h)^{n+1,(k)} \equiv (\rho Y_m,\rho h)^{(k)}$.
\item {\bf Step 2B:} ({\it Corrector}) Iteratively improve the accuracy of
               $(\rho Y_m,\rho h)^{(k)}$, for $k \in (1,k_{\rm max})$. 
               The final iteration defines the time-advanced state, 
               $(\rho Y_m,\rho h)^{n+1} = (\rho Y_m,\rho h)^{(k_{\rm max})}$.
\end{itemize}
To formally achieve
second-order accuracy, $k_{\rm max} \ge 1$.  A larger value of $k_{\rm max}$ will reduce the error 
of the final solution to that of the underlying quadrature scheme used to integrate (\ref{eq:MISDCint}),
but cannot further improve the convergence rate of the method.

{\bf MISDC Step 2A-I:} Compute $(\lambda,c_p,\mathcal D_m,h_m)^n$ from $(Y_m,T)^n$.  Compute 
$\widetilde\Gamma_m^n = \rho^n \mathcal D_m^n \nabla Y_m^n$ and conservatively
correct these fluxes as discussed in Section \ref{sec:Low Mach Number Equation Set} 
to obtain $\Gamma_m^n$.  Use a second-order Godunov integrator to compute 
time-centered edge states, $(\rho Y_m,\rho h)^{n+\myhalf,(0)}$, with explicitly evaluated diffusion
processes and time-lagged reaction processes (i.e., $I_R^{\rm lagged}$) as source terms.
Then, compute the time-advanced density, $\rho^{n+1}$, using a time-explicit discretization
of (\ref{eq:continuity}),
\begin{equation}
\frac{\rho^{n+1} - \rho^n}{\Delta t} = -\sum_m\nabla\cdot\left(\uadv\rho Y_m\right)^{n+\myhalf,(0)}.
\end{equation}

{\bf Step 2A-II:} Compute provisional, time-advanced species mass fractions,
$\widetilde Y_{m,{\rm AD}}^{(0)}$, using a discretization of (\ref{eq:cons mass}) with lagged transport coefficients 
and time-lagged reaction source terms,
\begin{equation}
\frac{\rho^{n+1}\widetilde Y_{m,{\rm AD}}^{(0)} - (\rho Y_m)^n}{\Delta t} = -\nabla\cdot\left(\uadv\rho Y_m\right)^{n+\myhalf,(0)} + \half\nabla\cdot\left(\Gamma_m^n + \rho^n\mathcal D_m^n\nabla\widetilde Y_{m,{\rm AD}}^{(0)}\right)+ I_{R,\rho Y_m}^{\rm lagged}.
\end{equation}
Each of the species equations requires a linear solve for $\widetilde Y_{m,{\rm AD}}^{(0)}$.\\

{\bf Step 2A-III:} Compute $\Gamma_{m,{\rm AD}}^{(0)}$, which are conservatively corrected versions of 
$\widetilde\Gamma_{m,{\rm AD}}^{(0)} = \rho^n\mathcal D_m^n\nabla\widetilde Y_{m,{\rm AD}}^{(0)}$, and compute updated provisional time-advanced species mass fractions, $Y_{m,{\rm AD}}^{(0)}$, using
\begin{equation}
\frac{\rho^{n+1}Y_{m,{\rm AD}}^{(0)} - (\rho Y_m)^n}{\Delta t} = \underbrace{-\nabla\cdot\left(\uadv\rho Y_m\right)^{n+\myhalf,(0)} + \half\nabla\cdot\left(\Gamma_m^n + \Gamma_{m,{\rm AD}}^{(0)}\right)}_{Q_{\rho Y_m}^{(0)}} + I_{R,\rho Y_m}^{\rm lagged},
\end{equation}
where $Q_{\rho Y_m}^{(0)}$ represents an effective contribution of advection-diffusion to the update of $\rho Y_m$.\\

{\bf Step 2A-IV:} Compute a provisional, time-advanced enthalpy, $h_{\rm AD}^{(0)}$, using a discretization
of (\ref{eq:cons energy}) with lagged transport coefficients,
\begin{eqnarray}
\frac{\rho^{n+1}h_{\rm AD}^{(0)} - (\rho h)^n}{\Delta t} &=& -\nabla\cdot\left(\uadv\rho h\right)^{n+\myhalf,(0)}\nonumber\\
&&\hspace{-2.5cm}+ \half\left(\nabla\cdot\frac{\lambda^n}{c_p^n}\nabla h^n + \nabla\cdot\frac{\lambda^n}{c_p^n}\nabla h_{\rm AD}^{(0)}\right)\nonumber\\
&&\hspace{-2.5cm}+ \half\sum_m\nabla\cdot\left[h_m^n\left(\Gamma_m^n - \frac{\lambda^n}{c_p^n}\nabla Y_m^n\right) + h_m^n\left(\Gamma_{m,{\rm AD}}^{(0)} - \frac{\lambda^n}{c_p^n}\nabla Y_{m,{\rm AD}}^{(0)}\right)\right].\label{eq:MISDC rhoh predictor}
\end{eqnarray}
Note that the enthalpy diffusion term is semi-implicit, requiring a linear solve for $h_{\rm AD}^{(0)}$.
The species enthalpy terms, $h_m$, are also lagged in order to avoid a more complicated linear system.
Once we have computed $h_{\rm AD}^{(0)}$, we define $Q_{\rho h}^{(0)}$ as the evaluation of the 
right-hand side of (\ref{eq:MISDC rhoh predictor}), which represents an effective contribution of 
advection-diffusion to the update of $\rho h$.\\

{\bf Step 2A-V:} Use VODE to integrate species (\ref{eq:cons mass}) and enthalpy (\ref{eq:cons energy}) over $\Delta t$
to advance $(\rho Y_m,\rho h)^n$ to $(\rho Y_m,\rho h)^{(0)}$ using the piecewise-constant
advection and diffusion source terms:
\begin{eqnarray}
\frac{\partial(\rho Y_m)}{\partial t} &=& Q_{\rho Y_m}^{(0)} + \dot\omega_m(Y_m,T),\label{eq:MISDC VODE 1}\\
\frac{\partial(\rho h)}{\partial t} &=& Q_{\rho h}^{(0)}.\label{eq:MISDC VODE 2}
\end{eqnarray}
Note that each evaluation of the right-hand-side in the VODE solve requires a call to the equation 
of state to obtain $T$ from $(Y_m,h)$ before computing $\dot\omega_m$.  After the 
integration is complete, we make one final call to the equation of state
to compute $T^{(0)}$ from $(Y_m,h)^{(0)}$.\\

{\bf Step 2A-VI:} Compute the effect of reactions in the evolution of $\rho Y_m$ (recall that reactions do not
affect $\rho h$) in the VODE integration using
\begin{equation}
I_{R,\rho Y_m}^{(0)} = \frac{(\rho Y_m)^{(0)} - (\rho Y_m)^n}{\Delta t} - Q_{\rho Y_m}^{(0)}.
\end{equation}

This is the end of the predictor.  In Step 2B, we improve upon the most recently computed
time-advanced solution by solving correction equations.  We are also able to compute more accurate
estimates of time-advanced thermodynamic coefficients, since we can use the most recently computed
solution.  We now describe Step 2B as if we are performing an arbitrary number of iterations 
from $k=0$ to $k_{\rm max}-1$.\\

{\bf Step 2B-I:} 
As in Step~2A-a, use a second-order Godunov integrator to compute updated time-centered edge states, 
$(\rho Y_m,\rho h)^{n+\myhalf,(k+1)}$, but use $I_R^{(k)}$ rather than
$I_R^{\rm lagged}$ as a source term in the Godunov integrator.\\

{\bf Step 2B-II:} Compute time-advanced transport coefficients, $(\lambda,c_p,\mathcal D_m,h_m)^{(k)}$ from $(Y_m,T)^{(k)}$.
Next, compute $\Gamma_m^{(k)}$, which are conservatively corrected versions of 
$\widetilde\Gamma_m^{(k)} = \rho^{n+1}\mathcal D_m^{(k)}\nabla Y_m^{(k)}$.
Then, compute provisional, time-advanced species mass fractions, $\widetilde Y_{m,{\rm AD}}^{(k+1)}$, by solving a backward Euler type
correction equation,
\begin{eqnarray}
\frac{\rho^{n+1}\widetilde Y_{m,{\rm AD}}^{(k+1)} - (\rho Y_m)^n}{\Delta t} &=& -\nabla\cdot\left(\uadv\rho Y_m\right)^{n+\myhalf,(k+1)}\nonumber\\
&&\hspace{-2.5cm}+ \nabla\cdot\rho^{n+1}\mathcal D_m^{(k)}\nabla\widetilde Y_{m,{\rm AD}}^{(k+1)}
+ \half\nabla\cdot\left(\Gamma_m^n - \Gamma_m^{(k)}\right)  + I_{R,\rho Y_m}^{(k)}.
\end{eqnarray}
Each of the species equations is implicit, requiring a linear solve for $\widetilde Y_{m,{\rm AD}}^{(k+1)}$.\\

{\bf Step 2B-III:} Compute $\Gamma_{m,{\rm AD}}^{(k+1)}$, which are conservatively corrected versions of 
$\widetilde\Gamma_{m,{\rm AD}}^{(k+1)} = \rho^{n+1}\mathcal D_m^{(k)}\nabla\widetilde Y_{m,{\rm AD}}^{(k+1)}$.
Then, similar to Step 2A-III, define an effective contribution of advection-diffusion to the update of $\rho Y_m$,
\begin{equation}
Q_{\rho Y_m}^{(k+1)} = -\nabla\cdot\left(\uadv\rho Y_m\right)^{n+\myhalf,(k+1)} + \nabla\cdot\Gamma_{m,{\rm AD}}^{(k+1)} + \half\nabla\cdot\left(\Gamma_m^n - \Gamma_m^{(k)}\right).
\end{equation}

{\bf Step 2B-IV:} Compute a provisional, time-advanced enthalpy, $h_{\rm AD}^{(k+1)}$, by solving a backward Euler type correction equation,
\begin{eqnarray}
\frac{\rho^{n+1}h_{\rm AD}^{(k+1)} - (\rho h)^n}{\Delta t} &=& -\nabla\cdot(\uadv\rho h)^{n+\myhalf,(k+1)}\nonumber\\
&&\hspace{-2.5cm}+ \nabla\cdot\frac{\lambda^{(k)}}{c_p^{(k)}}\nabla  h_{\rm AD}^{(k+1)} + \half\left(\nabla\cdot\frac{\lambda^n}{c_p^n}\nabla h^n - \nabla\cdot\frac{\lambda^{(k)}}{c_p^{(k)}}\nabla h^{(k)}\right)\nonumber\\
&&\hspace{-2.5cm}+ \half\sum_m\nabla\cdot\left[h_m^n\left(\Gamma_m^n - \frac{\lambda^n}{c_p^n}\nabla Y_m^n\right) + h_m^{(k)}\left(\Gamma_m^{(k)} - \frac{\lambda^{(k)}}{c_p^{(k)}}\nabla Y_m^{(k)}\right)\right].
\label{eq:MISDC rhoh correction}
\end{eqnarray}
The enthalpy term is implicit, requiring a linear solve for $h_{\rm AD}^{(k+1)}$, whereas the 
species enthalpy terms, $h_m$, are discretized with a trapezoidal rule using iteratively lagged, 
time-advanced values of $h_m$ in order to avoid a more complicated linear system.
Once we have computed $h_{\rm AD}^{(k+1)}$, we define
$Q_{\rho h}^{(k+1)}$ as the evaluation of the right-hand side of (\ref{eq:MISDC rhoh correction}),
which represents an effective contribution of advection-diffusion to the update of $\rho h$.\\

{\bf Step 2B-V:} Use VODE to integrate species (\ref{eq:cons mass}) and enthalpy (\ref{eq:cons energy}) over $\Delta t$
to advance $(\rho Y_m,\rho h)^n$ to $(\rho Y_m,\rho h)^{(k+1)}$ using piecewise-constant
advection and diffusion source terms:
\begin{eqnarray}
\frac{\partial(\rho Y_m)}{\partial t} &=& Q_{\rho Y_m}^{(k+1)} + \dot\omega_m(Y_m,T),\label{eq:MISDC VODE 3}\\
\frac{\partial(\rho h)}{\partial t} &=& Q_{\rho h}^{(k+1)}.\label{eq:MISDC VODE 4}
\end{eqnarray}
After the integration is complete, we make one final call to the equation of state
to compute $T^{(k+1)}$ from $(Y_m,h)^{(k+1)}$.\\

{\bf Step 2B-VI:} Compute the effect of reactions in the evolution of $\rho Y_m$ in the VODE integration using,
\begin{equation}
I_{R,\rho Y_m}^{(k+1)} = \frac{(\rho Y_m)^{(k+1)} - (\rho Y_m)^n}{\Delta t} - Q_{\rho Y_m}^{(k+1)}.
\end{equation}
If $k<k_{\rm max}-1$, set $k=k+1$ and return to MISDC Step 2B-I.  Otherwise, the 
time-advancement of the thermodynamic variables is complete, and set 
$(\rho Y_m,\rho h)^{n+1} = (\rho Y_m,\rho h)^{(k+1)}$.
