
\section{Downloading the Code}

\pelelm\ is built on top of the \iamr\ code, which itself built on top of the \amrex\ framework.  In order to run
\pelelm\, you must download separate git modules for \pelelm, \iamr, and \amrex.

\vspace{.1in}

\noindent First, make sure that {\tt git} is installed on your machine---we recommend version 1.7.x or higher.

\vspace{.1in}

\begin{enumerate}

\item Download the \amrex\ repository by typing: 
\begin{verbatim}
git clone https://github.com/AMReX-Codes/amrex.git
\end{verbatim}

This will create a folder called {\tt amrex/} on your machine.
Set the environment variable, {\tt AMREX\_HOME}, on your
machine to point to the path name where you have put \amrex.
You can add this to your {\tt .bashrc} as:
\begin{verbatim}
export AMREX_HOME="/path/to/amrex/"
\end{verbatim}

\item Download the \iamr\ repository by typing: 
\begin{verbatim}
git clone https://github.com/AMReX-Codes/IAMR.git
\end{verbatim}

This will create a folder called {\tt IAMR/} on your machine.
Set the environment variable, {\tt IAMR\_HOME}.

\item Obtain an ORNL GitLab account and clone the \pele\ repositories:
\begin{verbatim}
git clone https://<username>@code.ornl.gov/Pele/PeleLM.git
\end{verbatim}
\begin{verbatim}
git clone https://<username>@code.ornl.gov/Pele/PelePhysics.git
\end{verbatim}

This will create folders called {\tt PeleLM/} and {\tt PelePhysics/} on your machine.
Set the environment variables, {\tt PELELM\_HOME} and {\tt PELE\_PHYSICS\_HOME}.

\item You will want to periodically update each of these repositories
by typing {\tt git pull} within each repository.

\end{enumerate}

%\clearpage

\section{Building the Code}

The {\tt PelePhysics/} repository contains chemistry models and the encapsulating source 
code that is used by both \pelelm\ and \pelec\ (the compressible framework).  More
information on the source and data files for the chemistry models is coming soon.

In \pelelm\ each different problem setup is stored in its own
sub-folder under {\tt PeleLM/Exec/}, and a local version of the 
\pelelm\ executable is built directly in that folder.  The name of the executable (generated by the make
system) encodes several of the build characteristics, including dimensionality of the problem,
compiler name, and whether {\tt MPI} and/or {\tt OpenMP} were linked with the executable.
Thus, several different build configurations may coexist simultaneously in a problem folder.

The build system is based on GNU make and is relatively self-contained.  We have accumulated 
specialized building setups over the years for a wide variety of hardware configurations, and 
the system is quite easy to modify to add new machine/OS/compiler types and site-specific 
options (optimizations, cross-compiles, user-maintained includes, module-based strategies, etc).
The system currently supports a wide range of Linux, OSX, Windows (via CYGWIN), AIX and BGL 
configurations. With some luck, your machine will be supported ``out of the box'' -- however, if 
you run into problems and need assistance building on your hardware, contact Marc Day (\url{MSDay@lbl.gov}).

In the following, we step through building a representative \pelelm\ executable.
\begin{enumerate}
\item We will work in the folder containing setup for the ``Flame In A Box'' problem in 2-d and 3-d
({\tt PeleLM/Exec/FlameInABox}).
In this setup, cold fuel enters the domain bottom and passes through a flame sheet.
Hot products exit the domain at the top.  The sides of the domain are periodic, and the coordinates are
cartesian. From the folder in which you checked out the {\tt PeleLM} git repo,
  type
\begin{verbatim}
cd PeleLM/Exec/FlameInABox
\end{verbatim}

\item In {\tt FlameInABox/}, edit the {\tt GNUmakefile}, and set

{\tt DIM = 2} (for example)

{\tt COMP = gnu} (or your favorite C++/F90 compiler suite)

{\tt DEBUG = FALSE}

{\tt USE\_MPI = TRUE}

{\tt USE\_OMP = FALSE}

If you want to try compilers other than those in the GNU suite, and you find that they don't
work, please let us know.

To build a serial (single-processor) code, set {\tt USE\_MPI = FALSE}.
This will compile the code without the MPI library.  If you want to do
a parallel run, set {\tt USE\_MPI = TRUE}.  In this
case, the build system will need to know about your MPI installation.
This can be done by editing the makefiles in the \amrex\ tree.
%A simpler approach uses the MPI compiler wrappers
%(e.g.\ {\tt mpic++} and {\tt mpif90}) to generate the 
%required paths\slash libs\slash etc automatically.  To enable this
%feature, set the shell environment variable {\tt
%BOXLIB\_USE\_MPI\_WRAPPERS=1} prior to typing {\tt make}.

The resulting executable will look something like {\tt PeleLM2d.gnu.MPI.ex},
suggesting that this is a 2-d version of the code, made with 
{\tt COMP=gnu} and {\tt USE\_MPI=TRUE}.

\end{enumerate}

\section{Running the Code}

\begin{enumerate}

\item \pelelm\ takes an input file as its first command-line argument.  The file may
contain a set of parameter definitions that will overrides defaults set in the code.
  To run \pelelm\ with an example inputs file, type:
\begin{verbatim}
./PeleLM2d.gnu.MPI.ex inputs.2d-regt
\end{verbatim}

\item \pelelm\ typically generates subfolders in the current folder that
  are named {\tt plt00000/}, {\tt plt00020/}, etc, and {\tt chk00000/},
  {\tt chk00020/}, etc. These are ``plotfiles'' and ``checkpoint''
  files. The plotfiles are used for visualization of derived fields; the checkpoint
  files are used for restarting the code.

  The output folders contain a set of ASCII and binary files.  The field
  data is generally written in a self-describing binary format; the 
  ASCII header files provide additional metadata to give AMR context to the field data.

\end{enumerate}

\section{Visualization of the Results}

There are several options for visualizing the data.  The popular
\visit\ package supports the \amrex\ file format natively, as does
the \yt\ python package.  The standard tool used within the
\amrex-community is \amrvis, a package developed and supported 
by CCSE that is designed specifically for highly efficient visualization
of block-structured hierarchical AMR data.

\begin{enumerate}

\item Get \amrvis:
\begin{verbatim}
git clone https://ccse.lbl.gov/pub/Downloads/Amrvis.git
\end{verbatim}

Then cd into {\tt Amrvis/}, edit the {\tt GNUmakefile} there
to set {\tt DIM = 2}, and again set {\tt COMP} to the compiler
suite you have. Leave {\tt DEBUG = FALSE}.

Type {\tt make} to build, resulting in an executable that
looks like {\tt amrvis2d...ex}.

If you want to build amrvis with {\tt DIM = 3}, you must first
download and build {\tt volpack}:
\begin{verbatim}
git clone https://ccse.lbl.gov/pub/Downloads/volpack.git
\end{verbatim}

Then cd into {\tt volpack/} and type {\tt make}.

Note: \amrvis\ requires the OSF/Motif libraries and headers. If you don't have these 
you will need to install the development version of motif through your package manager. 
{\tt lesstif} gives some functionality and will allow you to build the amrvis executable, 
but \amrvis\ may exhibit subtle anomalies.

On most Linux distributions, the motif library is provided by the
{\tt openmotif} package, and its header files (like {\tt Xm.h}) are provided
by {\tt openmotif-devel}. If those packages are not installed, then use the
OS-specific package management tool to install them. 

You may then want to create an alias to {\tt amrvis2d}, for example
\begin{verbatim}
alias amrvis2d /tmp/Amrvis/amrvis2d...ex
\end{verbatim}

\item Return to the {\tt PeleLM/Exec/FlameInABox} folder.  You should
  have a number of output files, including some in the form {\tt *pltXXXXX},
  where {\tt XXXXX} is a number corresponding to the timestep the file
  was output.  {\tt amrvis2d <filename>} to see a single plotfile, 
   or {\tt amrvis2d -a *plt*}, which will animate the sequence of plotfiles.

  Try playing
  around with this---you can change which variable you are
  looking at, select a region and click ``Dataset'' (under View)
  in order to look at the actual numbers, etc. You can also export the
  pictures in several different formats under "File/Export".

We have created a number of routines to convert \amrex\ plotfile data
other formats (such as MATLAB), but in order to properly interpret 
the hierarchical AMR data, each tends to have its own idiosyncrasies.
If you would like to display the data in another format, please let us know
(again, {\tt MSDay@lbl.gov}) and we will point you to whatever we have
that can help.

\end{enumerate}

You have now completed a brief introduction to \pelelm. 


\section{Other Distributed Problem Setups}
{\tt PeleLM/Exec/DiffFlame} - More info soon!
